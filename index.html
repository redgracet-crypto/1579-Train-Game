<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Holiday Train Hop</title>
  <style>
    html,body{margin:0;height:100%;background:#0b1020;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #wrap{display:flex;flex-direction:column;height:100%}
    #hud{padding:10px 12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;background:rgba(0,0,0,.30);backdrop-filter:blur(6px)}
    #msg{margin-left:auto;opacity:.95;min-width:260px;text-align:right}
    button{border:0;border-radius:14px;padding:10px 14px;cursor:pointer;background:rgba(255,255,255,.12);color:#fff;font-weight:900}
    button:hover{background:rgba(255,255,255,.18)}
    button:disabled{opacity:.45;cursor:not-allowed}
    canvas{width:100%;height:100%;display:block}

    #lbOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:9999}
    #lbCard{width:min(520px,92vw);background:rgba(10,12,22,.92);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.45)}
    #lbCard h2{margin:0 0 10px 0;font-size:18px}
    #lbCard .sub{opacity:.85;font-size:13px;margin-bottom:12px}
    #lbList{display:flex;flex-direction:column;gap:8px;margin:10px 0 14px 0}
    .lbRow{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px 12px;font-size:14px}
    .lbRow .left{display:flex;gap:10px;align-items:center}
    .rank{width:26px;height:26px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.10);font-weight:900}
    .lbRow .name{font-weight:800}
    .lbRow .meta{opacity:.85;font-variant-numeric:tabular-nums}
    #lbActions{display:flex;gap:10px;justify-content:flex-end}
  </style>
</head>
<body>
<div id="wrap">
  <div id="hud">
    <button id="startBtn">Start Daily Run</button>
    <button id="showLBBtn">Leaderboard</button>

    <div>User: <b id="userLabel">‚Äî</b></div>
    <div>Day: <b id="dayLabel">‚Äî</b></div>
    <div>Lives: <b id="livesLabel">3</b></div>
    <div>Bells: <b id="bellsLabel">0</b></div>
    <div>Score: <b id="scoreLabel">0</b></div>

    <div id="msg">Loading‚Ä¶</div>
  </div>
  <canvas id="c"></canvas>
</div>

<div id="lbOverlay">
  <div id="lbCard">
    <h2>üöÇ Daily Leaderboard</h2>
    <div class="sub" id="lbSub">‚Äî</div>
    <div id="lbList"></div>
    <div id="lbActions"><button id="lbCloseBtn">Close</button></div>
  </div>
</div>

<script>
(() => {
  // ‚úÖ WORKING API URL (leave exactly like this)
  const API_URL = "https://script.google.com/macros/s/AKfycbwQQCcwb4AQSDFsoGCN6jxHrU2An58X6df0ZIfH_fJ7F4Ae1isuxz_fQaS2dv7FEMOJ-A/exec";

  // Event window
  const START = new Date("2025-12-20T00:01:00");
  const END   = new Date("2025-12-30T23:59:59");

  // UI
  const msgEl   = document.getElementById("msg");
  const userEl  = document.getElementById("userLabel");
  const dayEl   = document.getElementById("dayLabel");
  const livesEl = document.getElementById("livesLabel");
  const bellsEl = document.getElementById("bellsLabel");
  const scoreEl = document.getElementById("scoreLabel");
  const startBtn = document.getElementById("startBtn");
  const showLBBtn = document.getElementById("showLBBtn");

  const lbOverlay = document.getElementById("lbOverlay");
  const lbList = document.getElementById("lbList");
  const lbSub = document.getElementById("lbSub");
  const lbCloseBtn = document.getElementById("lbCloseBtn");

  lbCloseBtn.addEventListener("click", () => lbOverlay.style.display = "none");
  lbOverlay.addEventListener("click", (e)=>{ if(e.target===lbOverlay) lbOverlay.style.display="none"; });

  // Canvas (just to keep your background visible)
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  function resize(){
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.floor(r.width * devicePixelRatio);
    canvas.height = Math.floor(r.height * devicePixelRatio);
  }
  window.addEventListener("resize", resize);
  resize();

  const bgImg = new Image();
  bgImg.src = "background.png";
  bgImg.onload = () => renderBg();

  function renderBg(){
    const W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    if(!bgImg.complete) return;
    const s = Math.max(W/bgImg.width, H/bgImg.height);
    const w=bgImg.width*s, h=bgImg.height*s;
    ctx.drawImage(bgImg, (W-w)/2, (H-h)/2, w, h);
  }

  // ========= JSONP (NO CORS ISSUES) =========
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("timeout"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cbName]; } catch {}
        s.remove();
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("load error")); };

      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName;
      document.head.appendChild(s);
    });
  }

  async function apiCall(params){
    params._ = String(Date.now());
    const url = API_URL + "?" + new URLSearchParams(params).toString();
    return await jsonp(url);
  }

  // API wrappers
  const checkinNameForToday = (name, day) => apiCall({ action:"checkin", name, day });
  const fetchLeaderboard = (day, limit=10) => apiCall({ action:"leaderboard", mode:"today", day, limit:String(limit) });

  // ========= User name =========
  const USER_KEY = "trainhop_username";
  function sanitizeName(s){
    s = (s || "").trim().replace(/[^\w\s\-'.!]/g, "");
    if (s.length > 18) s = s.slice(0,18);
    return s;
  }
  function getUsername(){ return localStorage.getItem(USER_KEY) || ""; }
  function setUsername(name){
    localStorage.setItem(USER_KEY, name);
    userEl.textContent = name || "‚Äî";
  }
  function bootstrapUser(){
    let name = sanitizeName(getUsername());
    if (!name){
      name = sanitizeName(prompt("1579 name for leaderboard? (use same every day)") || "");
      if (!name) name = "Guest";
      setUsername(name);
    } else userEl.textContent = name;
  }

  // ========= Dates =========
  function pad2(n){ return String(n).padStart(2,"0"); }
  function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function inWindow(now){ return now>=START && now<=END; }
  function dayIndex(now){
    const startMid = new Date(START.getFullYear(), START.getMonth(), START.getDate());
    const nowMid = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    return Math.floor((nowMid - startMid)/(24*60*60*1000)) + 1;
  }

  function updateGateUI(){
    const now = new Date();
    bootstrapUser();

    if (now < START){
      msgEl.textContent = "üöÇ Not open yet. Opens 12/20/2025 at 00:01.";
      startBtn.disabled = true;
      dayEl.textContent = "‚Äî";
      return;
    }
    if (now > END){
      msgEl.textContent = "‚ùÑÔ∏è Event ended. Closed after 12/30/2025 23:59.";
      startBtn.disabled = true;
      dayEl.textContent = "‚Äî";
      return;
    }
    dayEl.textContent = `${dayIndex(now)} / 11`;
    msgEl.textContent = "üéÅ One play per name per day. Good luck.";
    startBtn.disabled = false;
  }

  function renderLeaderboardList(rows){
    lbList.innerHTML = "";
    if (!rows || rows.length === 0){
      lbList.innerHTML = `<div class="lbRow"><div class="left"><div class="rank">‚Äî</div><div class="name">No scores yet today</div></div><div class="meta">‚ùÑÔ∏è</div></div>`;
      return;
    }
    rows.forEach((r,i)=>{
      const el = document.createElement("div");
      el.className="lbRow";
      el.innerHTML = `<div class="left"><div class="rank">${i+1}</div><div class="name">${String(r.name||"").replace(/</g,"&lt;")}</div></div><div class="meta">${r.score} pts ‚Ä¢ ${Number(r.time||0).toFixed(1)}s</div>`;
      lbList.appendChild(el);
    });
  }

  async function showLeaderboard(openOverlay){
    const now = new Date();
    const day = ymd(now);
    lbSub.textContent = `Day ${dayIndex(now)} / 11 ‚Ä¢ ${day}`;
    try{
      const r = await fetchLeaderboard(day, 10);
      if(r && r.ok) renderLeaderboardList(r.top || []);
      else renderLeaderboardList([]);
    }catch{
      renderLeaderboardList([]);
    }
    if(openOverlay) lbOverlay.style.display="flex";
  }

  showLBBtn.addEventListener("click", ()=>showLeaderboard(true));

  async function startDailyRun(){
    const now = new Date();
    if (!inWindow(now)) return updateGateUI();

    bootstrapUser();
    const name = sanitizeName(getUsername()) || "Guest";
    const day = ymd(now);

    startBtn.disabled = true;
    msgEl.textContent = "Checking in (one play per name per day)‚Ä¶";

    try{
      const r = await checkinNameForToday(name, day);
      if(!r || !r.ok){
        msgEl.textContent = "‚ö†Ô∏è Server error. Try again.";
        startBtn.disabled = false;
        return;
      }
      if(!r.allowed){
        msgEl.textContent = "‚úÖ Already played today (for this name). Come back tomorrow!";
        startBtn.disabled = true;
        await showLeaderboard(false);
        return;
      }

      msgEl.textContent = `‚úÖ Checked in for today, ${name}.`;
      // This safe build only confirms check-in + leaderboard.
      // Your full platformer game loop plugs in after this line.

    }catch(e){
      msgEl.textContent = "‚ö†Ô∏è Network error. Try again.";
      startBtn.disabled = false;
    }
  }

  startBtn.addEventListener("click", startDailyRun);

  // Init
  msgEl.textContent = "Ready.";
  bootstrapUser();
  updateGateUI();
  setInterval(updateGateUI, 15000);
  renderBg();
})();
</script>
</body>
</html>

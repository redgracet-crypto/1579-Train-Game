<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Holiday Train Hop</title>
  <style>
    html, body { margin:0; height:100%; background:#0b1020; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #wrap { display:flex; flex-direction:column; height:100%; }
    #hud {
      padding:10px 12px;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background:rgba(0,0,0,.30); backdrop-filter: blur(6px);
    }
    #hud b { font-weight:900; }
    #msg { margin-left:auto; opacity:.95; min-width:260px; text-align:right; }
    canvas { width:100%; height:100%; display:block; touch-action:none; }
    button {
      border:0; border-radius:14px; padding:10px 14px; cursor:pointer;
      background:rgba(255,255,255,.12); color:#fff; font-weight:900;
    }
    button:hover { background:rgba(255,255,255,.18); }
    button:disabled { opacity:.45; cursor:not-allowed; }

    #lbOverlay {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); backdrop-filter: blur(6px);
      z-index:9999;
    }
    #lbCard {
      width:min(520px, 92vw);
      background:rgba(10,12,22,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
    }
    #lbCard h2 { margin:0 0 10px 0; font-size:18px; }
    #lbCard .sub { opacity:.85; font-size:13px; margin-bottom:12px; }
    #lbList { display:flex; flex-direction:column; gap:8px; margin:10px 0 14px 0; }
    .lbRow {
      display:flex; justify-content:space-between; align-items:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      font-size:14px;
    }
    .lbRow .left { display:flex; gap:10px; align-items:center; }
    .rank {
      width:26px; height:26px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.10);
      font-weight:900;
    }
    .lbRow .name { font-weight:800; }
    .lbRow .meta { opacity:.85; font-variant-numeric: tabular-nums; }
    #lbActions { display:flex; gap:10px; justify-content:flex-end; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="hud">
    <button id="startBtn">Start Daily Run</button>
    <button id="showLBBtn">Leaderboard</button>

    <div>User: <b id="userLabel">â€”</b></div>
    <div>Day: <b id="dayLabel">â€”</b></div>
    <div>Lives: <b id="livesLabel">3</b></div>
    <div>Bells: <b id="bellsLabel">0</b></div>
    <div>Score: <b id="scoreLabel">0</b></div>

    <div id="msg">Loadingâ€¦</div>
  </div>

  <canvas id="c"></canvas>
</div>

<div id="lbOverlay">
  <div id="lbCard">
    <h2>ðŸš‚ Daily Leaderboard</h2>
    <div class="sub" id="lbSub">â€”</div>
    <div id="lbList"></div>
    <div id="lbActions">
      <button id="lbCloseBtn">Close</button>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================
  //  BACKEND URL (your Apps Script)
  // =========================
  const API_URL = "https://script.google.com/macros/s/AKfycbzebjBqpqvxjAqAX3SbWqICXizAS5BWJRagY41nkXo2oV3ZauminLd05a905kXYxr727g/exec";

  // =========================
  //  JSONP (bypasses CORS)
  // =========================
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("JSONP timeout"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cbName]; } catch {}
        s.remove();
      }

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName;
      s.onerror = () => {
        cleanup();
        reject(new Error("JSONP load error"));
      };

      document.head.appendChild(s);
    });
  }

  async function apiCall(params){
    params._ = String(Date.now());
    const url = API_URL + "?" + new URLSearchParams(params).toString();
    return await jsonp(url);
  }

  async function checkinNameForToday(name, day){
    return apiCall({ action:"checkin", name, day });
  }
  async function submitScore(name, day, score, time){
    return apiCall({ action:"submit", name, day, score:String(score), time:String(time) });
  }
  async function fetchLeaderboard(day, limit=10){
    return apiCall({ action:"leaderboard", mode:"today", day, limit:String(limit) });
  }

  // =========================
  //  TIME WINDOW
  // =========================
  const START = new Date("2025-12-20T00:01:00");
  const END   = new Date("2025-12-30T23:59:59");

  // =========================
  //  UI ELEMENTS
  // =========================
  const msgEl   = document.getElementById("msg");
  const userEl  = document.getElementById("userLabel");
  const dayEl   = document.getElementById("dayLabel");
  const livesEl = document.getElementById("livesLabel");
  const bellsEl = document.getElementById("bellsLabel");
  const scoreEl = document.getElementById("scoreLabel");
  const startBtn = document.getElementById("startBtn");
  const showLBBtn = document.getElementById("showLBBtn");

  const lbOverlay = document.getElementById("lbOverlay");
  const lbList = document.getElementById("lbList");
  const lbSub = document.getElementById("lbSub");
  const lbCloseBtn = document.getElementById("lbCloseBtn");

  lbCloseBtn.addEventListener("click", () => lbOverlay.style.display = "none");
  lbOverlay.addEventListener("click", (e) => { if (e.target === lbOverlay) lbOverlay.style.display = "none"; });

  // =========================
  //  CANVAS
  // =========================
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  function resize(){
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.floor(rect.width * devicePixelRatio);
    canvas.height = Math.floor(rect.height * devicePixelRatio);
  }
  window.addEventListener("resize", resize);
  resize();

  // =========================
  //  INPUT
  // =========================
  const keys = new Set();
  window.addEventListener("keydown", (e) => keys.add(e.key.toLowerCase()));
  window.addEventListener("keyup",   (e) => keys.delete(e.key.toLowerCase()));

  // =========================
  //  ASSET LOADING
  // =========================
  const bgImg = new Image();
  bgImg.src = "background.png";
  const spriteImg = new Image();
  spriteImg.src = "SpriteSheet.png";

  let assetsReady = false;
  let loaded = 0;
  function onAssetLoad(){
    loaded++;
    if (loaded === 2){
      assetsReady = true;
      msgEl.textContent = "Ready.";
      bootstrapUser();
      updateGateUI();
      render();
    }
  }
  bgImg.onload = onAssetLoad;
  spriteImg.onload = onAssetLoad;

  // =========================
  //  SPRITE MAP (approx)
  // =========================
  const SPRITES = {
    platform:       { x:   0, y:   0, w: 500, h: 140 },
    platformNarrow: { x:   0, y: 145, w: 320, h: 110 },
    movingPlatform: { x: 330, y: 145, w: 520, h: 140 },
    spikes: { x:   0, y: 270, w: 420, h: 130 },
    bell:   { x: 840, y: 150, w: 160, h: 160 },
    goal: { x: 1000, y:  0, w: 520, h: 520 },
  };

  // =========================
  //  HELPERS
  // =========================
  function pad2(n){ return String(n).padStart(2,"0"); }
  function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function inWindow(now){ return now >= START && now <= END; }

  function dayIndex(now){
    const startMid = new Date(START.getFullYear(), START.getMonth(), START.getDate());
    const nowMid   = new Date(now.getFullYear(),  now.getMonth(),  now.getDate());
    const ms = nowMid - startMid;
    return Math.floor(ms / (24*60*60*1000)) + 1; // 1..11
  }

  // =========================
  //  USERNAME
  // =========================
  const USER_KEY = "trainhop_username";
  function sanitizeName(s){
    s = (s || "").trim();
    s = s.replace(/[^\w\s\-'.!]/g, "");
    if (s.length > 18) s = s.slice(0, 18);
    return s;
  }
  function getUsername(){ return localStorage.getItem(USER_KEY) || ""; }
  function setUsername(name){
    localStorage.setItem(USER_KEY, name);
    userEl.textContent = name || "â€”";
  }
  function bootstrapUser(){
    let name = sanitizeName(getUsername());
    if (!name){
      name = sanitizeName(prompt("1579 name for leaderboard? (use same every day)") || "");
      if (!name) name = "Guest";
      setUsername(name);
    } else {
      userEl.textContent = name;
    }
  }

  // =========================
  //  GAME CONSTANTS
  // =========================
  const MAX_LIVES = 3;
  const ALL_BELLS = 3;

  const SCORE_BELL = 150;
  const SCORE_WIN  = 3000;

  const TIME_BONUS_MAX = 2500;
  const TIME_SAFE_SECONDS = 25;
  const TIME_DECAY_PER_SEC = 85;

  const G = 0.74;
  const JUMP = -13.1;
  const SPEED = 5.0;
  const FRICTION = 0.80;
  const AIR_CTRL = 0.55;

  // =========================
  //  GAME STATE
  // =========================
  let p

